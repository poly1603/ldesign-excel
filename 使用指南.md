# 📖 Excel Viewer v2.0 - 使用指南

## 快速开始

### 安装

```bash
npm install @ldesign/excel-viewer-core
```

### 基础使用

```typescript
import { ExcelViewer } from '@ldesign/excel-viewer-core';

const viewer = new ExcelViewer({
  container: '#app',
  showToolbar: true,
  allowEdit: true,
  lang: 'zh-CN',
});

await viewer.loadFile(file);
```

## 核心功能

### 1. 公式计算

支持 100+ Excel 函数

```typescript
import { FormulaEngine } from '@ldesign/excel-viewer-core';

const engine = new FormulaEngine();

// 设置单元格值
engine.setCellValue('A1', 10);
engine.setCellValue('A2', 20);

// 计算公式
const result = engine.calculate('=SUM(A1:A2)');
console.log(result.value); // 30
```

**支持的函数分类**:
- 数学: SUM, AVERAGE, MAX, MIN, ROUND, POWER...
- 逻辑: IF, AND, OR, NOT, IFERROR...
- 文本: CONCATENATE, LEFT, RIGHT, UPPER, LOWER...
- 日期: TODAY, NOW, DATE, YEAR, MONTH...
- 查找: VLOOKUP, HLOOKUP, INDEX, MATCH...

### 2. 数据验证

```typescript
import { DataValidator, ValidationType, ValidationOperator } from '@ldesign/excel-viewer-core';

const validator = new DataValidator();

// 整数范围验证
validator.addRule('A1', {
  type: ValidationType.WHOLE_NUMBER,
  operator: ValidationOperator.BETWEEN,
  formula1: '1',
  formula2: '100',
  errorMessage: '请输入 1-100 之间的整数',
});

// 下拉列表
validator.addRule('B1', {
  type: ValidationType.LIST,
  list: ['选项1', '选项2', '选项3'],
  showDropdown: true,
});

// 验证
const result = validator.validate('A1', 50);
if (!result.valid) {
  console.error(result.error);
}
```

### 3. 查找替换

```typescript
import { FindReplaceManager } from '@ldesign/excel-viewer-core';

const manager = new FindReplaceManager();

// 查找
const results = manager.find(data, {
  keyword: 'hello',
  caseSensitive: false,
  useRegex: false,
});

// 替换
manager.replace(data, {
  keyword: 'hello',
  replaceText: 'world',
  replaceAll: true,
});
```

### 4. 高级筛选

```typescript
import { FilterSortManager, FilterType, LogicalOperator } from '@ldesign/excel-viewer-core';

const manager = new FilterSortManager();

// 筛选
const result = manager.filterAndSort(data, {
  operator: LogicalOperator.AND,
  conditions: [
    { column: 0, type: FilterType.GREATER_THAN, value1: 100 },
    { column: 1, type: FilterType.CONTAINS, value1: '北京' },
  ],
});
```

### 5. 条件格式

```typescript
import { ConditionalFormatManager, ConditionalFormatType } from '@ldesign/excel-viewer-core';

const manager = new ConditionalFormatManager();

// 数据条
manager.addRule({
  id: 'rule1',
  type: ConditionalFormatType.DATA_BAR,
  range: { startRow: 1, startCol: 0, endRow: 100, endCol: 0 },
  dataBar: {
    color: '#4472C4',
    showValue: true,
  },
});

// 应用
const results = manager.apply(data);
```

### 6. 快捷键

```typescript
import { KeyboardManager } from '@ldesign/excel-viewer-core';

const keyboard = new KeyboardManager();

// 自定义快捷键
keyboard.register({
  key: 's',
  modifiers: { ctrl: true },
  handler: () => {
    console.log('保存');
    return false; // 阻止默认行为
  },
  description: '保存',
});

keyboard.startListening();
```

### 7. 国际化

```typescript
import { getI18n } from '@ldesign/excel-viewer-core';

const i18n = getI18n();

// 切换语言
i18n.setLocale('en-US');

// 翻译
const text = i18n.t('common.save');

// 格式化
const date = i18n.formatDate(new Date());
const number = i18n.formatNumber(1234.56);
const currency = i18n.formatCurrency(99.99);
```

## 性能优化

### Web Worker 后台解析

```typescript
const viewer = new ExcelViewer({
  container: '#app',
  performance: {
    useWebWorker: true,  // 启用 Worker
    chunkSize: 10000,    // 分块大小
    lazyLoad: true,      // 懒加载
  },
});
```

### 内存管理

```typescript
import { LRUCache, MemoryMonitor } from '@ldesign/excel-viewer-core';

// LRU 缓存
const cache = new LRUCache(100);
cache.set('key', value);
const stats = cache.getStats();

// 内存监控
const monitor = new MemoryMonitor();
monitor.onMemoryChange((info) => {
  console.log(`内存使用: ${info.usageRatio * 100}%`);
});
monitor.start();
```

## 导出功能

```typescript
// 导出为 Excel
viewer.downloadFile({
  format: 'xlsx',
  filename: 'export.xlsx',
  includeStyles: true,
  includeFormulas: true,
});

// 导出为 CSV
viewer.downloadFile({
  format: 'csv',
  filename: 'export.csv',
});

// 导出截图
await viewer.downloadScreenshot('screenshot.png');
```

## 事件监听

```typescript
viewer.on('load', (data) => {
  console.log('文件加载完成', data);
});

viewer.on('cellChange', (data) => {
  console.log('单元格变化', data);
});

viewer.on('error', (data) => {
  console.error('错误', data);
});
```

## 完整示例

```typescript
import {
  ExcelViewer,
  FormulaEngine,
  DataValidator,
  FindReplaceManager,
  FilterSortManager,
  ConditionalFormatManager,
  getI18n,
} from '@ldesign/excel-viewer-core';

// 创建查看器
const viewer = new ExcelViewer({
  container: '#app',
  showToolbar: true,
  allowEdit: true,
  lang: 'zh-CN',
  performance: {
    useWebWorker: true,
    chunkSize: 10000,
    lazyLoad: true,
  },
});

// 加载文件
await viewer.loadFile(file);

// 公式计算
const engine = new FormulaEngine();
engine.setCellValue('A1', 100);
const result = engine.calculate('=A1*2');

// 数据验证
const validator = new DataValidator();
validator.addRule('A1', {
  type: 'whole_number',
  operator: 'between',
  formula1: '1',
  formula2: '100',
});

// 查找替换
const findReplace = new FindReplaceManager();
const results = findReplace.find(data, {
  keyword: 'test',
  caseSensitive: false,
});

// 筛选排序
const filterSort = new FilterSortManager();
const filtered = filterSort.filterAndSort(data, filterGroup, sortRules);

// 条件格式
const conditionalFormat = new ConditionalFormatManager();
conditionalFormat.addRule(rule);
const formatted = conditionalFormat.apply(data);

// 国际化
const i18n = getI18n();
i18n.setLocale('zh-CN');
const text = i18n.t('common.save');
```

## 更多资源

- 📚 [API 参考文档](./API_REFERENCE.md)
- 🚀 [优化总结](./OPTIMIZATION_SUMMARY.md)
- 📖 [完整 README](./README_V2.md)
- ✅ [交付清单](./DELIVERY_CHECKLIST.md)

## 常见问题

### 1. 如何处理大文件?

启用 Web Worker 和懒加载:

```typescript
const viewer = new ExcelViewer({
  performance: {
    useWebWorker: true,
    lazyLoad: true,
  },
});
```

### 2. 如何自定义快捷键?

```typescript
const keyboard = getKeyboardManager();
keyboard.register({
  key: 's',
  modifiers: { ctrl: true, shift: true },
  handler: () => { /* 自定义操作 */ },
});
```

### 3. 如何添加自定义函数?

```typescript
const engine = new FormulaEngine();
engine.registerFunction('CUSTOM', (x) => x * 2);
```

---

**版本**: v2.0.0
**更新时间**: 2024-10-22


